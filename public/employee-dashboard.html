<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tableau de bord Employé</title>
    <style>
      :root { --brand:#1976d2; --brand-dark:#0d47a1; --text:#1f2937; --muted:#6b7280; --bg:#f3f4f6; --card:#ffffff; }
      * { box-sizing: border-box; }
      body { margin: 0; font-family: Arial, sans-serif; color: var(--text); background: var(--bg); }
      header { background: var(--card); border-bottom: 1px solid #e5e7eb; padding: 10px 16px; display:flex; align-items:center; justify-content:space-between; }
      .brand { display:flex; align-items:center; gap:10px; }
      .brand img { height:36px; width:36px; object-fit:contain; }
      .brand h1 { font-size:18px; margin:0; color: var(--brand-dark); }
      nav { display:flex; gap:8px; }
      .tab { background:#e3f2fd; color:var(--brand-dark); border:none; padding:8px 12px; border-radius:9999px; cursor:pointer; font-weight:600; }
      .tab.active { background:var(--brand); color:#fff; }
      .container { max-width:980px; margin: 20px auto; padding: 0 16px; }
      .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
      input, select, button { width: 100%; padding: 10px; margin: 8px 0; border-radius:10px; border:1px solid #e5e7eb; }
      input:focus, select:focus { outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(25,118,210,0.15); }
      button.primary { background:var(--brand); color:#fff; border:none; cursor:pointer; font-weight:600; }
      button.primary:hover { background:var(--brand-dark); }
      table { width: 100%; border-collapse: collapse; margin-top: 12px; }
      th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
      tbody tr:hover { background: #f9fbff; }
      .badge { display:inline-block; padding:4px 8px; border-radius:9999px; font-size:12px; font-weight:600; }
      .badge.encours { background:#fff7e6; color:#b26a00; border:1px solid #ffe0a3; }
      .badge.livré { background:#e7f7ef; color:#0b7a42; border:1px solid #bde8cf; }
      .hidden { display:none; }
      .section { padding: 12px 0; }
      .section.narrow .card { max-width: 560px; margin: 0 auto; }
      .section.wide .card { max-width: 100%; margin: 0 auto; }
      .center { text-align: center; }
      .subtitle { color: var(--muted); margin: 4px 0 0; font-size: 14px; }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">
        <img src="/asset/téléchargement.jpg" alt="Zalagh" />
        <h1>Espace Employé</h1>
      </div>
      <nav>
        <button class="tab active" data-target="section-profil">Profil</button>
        <button class="tab" data-target="section-creer">Créer une demande</button>
        <button class="tab" data-target="section-demandes">Mes demandes</button>
        <button id="logout" class="tab" style="background:#ffecec;color:#b00020;">Déconnexion</button>
      </nav>
    </header>
    <div class="container">
      <section id="section-profil" class="section narrow">
        <div class="card center">
          <img src="/asset/téléchargement.jpg" alt="Zalagh" style="height:64px;width:64px;object-fit:contain;" />
          <h2 style="margin:8px 0 4px;">Bienvenue</h2>
          <div id="me" class="subtitle"></div>
        </div>
      </section>
      <section id="section-creer" class="section narrow hidden">
        <div class="card">
          <h3 class="center">Créer une demande</h3>
          <form id="demandeForm" enctype="multipart/form-data">
            <label>Nom</label>
            <input id="d_nom" required />
            <label>Prénom</label>
            <input id="d_prenom" required />
            <label>Type de projet</label>
            <input id="d_type" required />
            <label>Plan JPG (upload)</label>
            <input id="d_plan" type="file" accept="image/jpeg,image/png" />
            <label>Prix</label>
            <input id="d_prix" type="number" step="0.01" required />
            <label>Statut</label>
            <select id="d_statut">
              <option value="encours">encours</option>
              <option value="livré">livré</option>
            </select>
            <button class="primary" type="submit">Créer</button>
          </form>
          <div id="demandeMsg"></div>
        </div>
      </section>
      <section id="section-demandes" class="section wide hidden">
        <div class="card">
          <h3 class="center">Mes demandes</h3>
          <table>
            <thead>
              <tr>
                <th>ID</th><th>Nom</th><th>Prénom</th><th>Type</th><th>Prix</th><th>Statut</th><th>Plan</th><th>Devis PDF</th><th>PDF signé</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </div>
    <script>
      const token = localStorage.getItem('employee_token');
      if (!token) location.href = '/';
      document.getElementById('logout').onclick = () => { localStorage.removeItem('employee_token'); location.href = '/'; };

      // Tabs handling
      document.querySelectorAll('.tab[data-target]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab[data-target]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const target = btn.getAttribute('data-target');
          document.querySelectorAll('section[id^="section-\\"]').forEach(s => s.classList.add('hidden'));
          const sec = document.getElementById(target);
          if (sec) sec.classList.remove('hidden');
        });
      });
      async function loadMe() {
        const res = await fetch('/api/employee/me', { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) { localStorage.removeItem('employee_token'); location.href = '/employee-login.html'; return; }
        const me = await res.json();
        const div = document.getElementById('me');
        div.textContent = `ID: ${me.id} | ${me.nom} ${me.prenom} | ${me.email || ''} | Secteur: ${me.secteur}`;
      }
      loadMe();

      async function loadDemandes() {
        const res = await fetch('/api/demandes', { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) return;
        const list = await res.json();
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        list.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.iddemande}</td>
            <td>${d.nom}</td>
            <td>${d.prenom}</td>
            <td>${d.type_projet}</td>
            <td>${d.prix}</td>
            <td>${d.statut ? `<span class=\"badge ${d.statut}\">${d.statut}</span>` : ''}</td>
            <td>${d.plan_jpg ? `<a href="/uploads/${d.plan_jpg}" target="_blank">voir</a>` : ''}</td>
            <td>${d.pdf_path ? `<a href="${d.pdf_path}" target="_blank">Devis PDF</a>` : ''}</td>
            <td>${d.pdf_signe_path ? `<a href="${d.pdf_signe_path}" target="_blank">PDF signé</a>` : ''}</td>
            <td><button data-id="${d.iddemande}" class="gen">Générer PDF</button></td>
          `;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button.gen').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.getAttribute('data-id');
            const r = await fetch(`/api/demandes/${id}/pdf`, { method: 'POST' });
            if (r.ok) loadDemandes();
          });
        });
      }
      document.getElementById('demandeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = new FormData();
        form.append('nom', document.getElementById('d_nom').value);
        form.append('prenom', document.getElementById('d_prenom').value);
        form.append('type_projet', document.getElementById('d_type').value);
        form.append('prix', document.getElementById('d_prix').value);
        form.append('statut', document.getElementById('d_statut').value);
        if (document.getElementById('d_plan').files[0]) {
          form.append('plan_jpg', document.getElementById('d_plan').files[0]);
        }
        const r = await fetch('/api/demandes', {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + token },
          body: form
        });
        const msg = document.getElementById('demandeMsg');
        if (!r.ok) { msg.textContent = 'Erreur création'; return; }
        msg.textContent = 'Demande créée';
        (document.getElementById('demandeForm')).reset();
        loadDemandes();
      });

      loadDemandes();
    </script>
    <!-- Système de Guide Interactif -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="/guide-system.js"></script>
  </body>
</html>


